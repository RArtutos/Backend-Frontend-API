{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Account Analytics</h2>
    
    <div class="row">
        <!-- Summary Cards -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Total Users</h5>
                    <h2 class="card-text">{{ analytics.total_users }}</h2>
                    <div class="mt-2">
                        <small class="text-success">
                            <i class="bi bi-arrow-up"></i> 
                            {{ ((analytics.active_users / analytics.total_users) * 100)|round|int }}% active
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Active Users</h5>
                    <h2 class="card-text">{{ analytics.active_users }}</h2>
                    <div class="mt-2">
                        <small class="text-{{ 'success' if analytics.active_users < analytics.max_concurrent_users else 'danger' }}">
                            {{ analytics.max_concurrent_users - analytics.active_users }} slots available
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Total Sessions</h5>
                    <h2 class="card-text">{{ analytics.total_sessions }}</h2>
                    <div class="mt-2">
                        <small class="text-muted">
                            Lifetime total
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Current Sessions</h5>
                    <h2 class="card-text">{{ analytics.current_sessions }}</h2>
                    <div class="mt-2">
                        <small class="text-{{ 'success' if analytics.current_sessions < analytics.max_concurrent_users else 'warning' }}">
                            {{ (analytics.current_sessions / analytics.max_concurrent_users * 100)|round|int }}% capacity
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Usage Over Time Chart -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Usage Over Time</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateTimeChart('day')">Day</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateTimeChart('week')">Week</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateTimeChart('month')">Month</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="usageTimeChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Domain Distribution -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Domain Usage Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="domainDistributionChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- User Activity Timeline -->
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Activity Timeline</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh">
                        <label class="form-check-label" for="autoRefresh">Auto refresh</label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Domain</th>
                                    <th>Time</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in analytics.user_activities %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-person-circle me-2"></i>
                                            {{ activity.user_id }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if activity.action == 'login' else 'danger' if activity.action == 'logout' else 'info' }}">
                                            {{ activity.action }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if activity.domain %}
                                        <span class="badge bg-secondary">{{ activity.domain }}</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>{{ activity.timestamp[:19].replace('T', ' ') }}</td>
                                    <td>
                                        {% if activity.duration %}
                                        {{ (activity.duration / 60)|round|int }} min
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if activity.active else 'secondary' }}">
                                            {{ 'Active' if activity.active else 'Ended' }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Domain Distribution Chart
    const domainCtx = document.getElementById('domainDistributionChart').getContext('2d');
    new Chart(domainCtx, {
        type: 'doughnut',
        data: {
            labels: {{ analytics.usage_by_domain|map(attribute='domain')|list|tojson }},
            datasets: [{
                data: {{ analytics.usage_by_domain|map(attribute='total_time')|list|tojson }},
                backgroundColor: [
                    '#4B91F1', '#FF6B6B', '#4BC0C0', '#FFCD56', '#C9CBCF',
                    '#B39DDB', '#81C784', '#FFB74D', '#E57373', '#9575CD'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12
                    }
                }
            }
        }
    });

    // Usage Over Time Chart
    const timeCtx = document.getElementById('usageTimeChart').getContext('2d');
    const timeChart = new Chart(timeCtx, {
        type: 'line',
        data: {
            labels: generateTimeLabels('day'),
            datasets: [{
                label: 'Active Sessions',
                data: generateRandomData(24),
                borderColor: '#4B91F1',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(75, 145, 241, 0.1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Auto refresh functionality
    const autoRefreshToggle = document.getElementById('autoRefresh');
    let refreshInterval;

    autoRefreshToggle.addEventListener('change', function() {
        if (this.checked) {
            refreshInterval = setInterval(refreshData, 30000); // 30 seconds
        } else {
            clearInterval(refreshInterval);
        }
    });

    // Helper functions
    function generateTimeLabels(period) {
        const labels = [];
        const now = moment();
        let count;
        let format;

        switch(period) {
            case 'day':
                count = 24;
                format = 'HH:mm';
                break;
            case 'week':
                count = 7;
                format = 'ddd';
                break;
            case 'month':
                count = 30;
                format = 'MMM D';
                break;
        }

        for (let i = count - 1; i >= 0; i--) {
            labels.push(moment(now).subtract(i, period === 'day' ? 'hours' : 'days').format(format));
        }
        return labels;
    }

    function generateRandomData(count) {
        return Array.from({length: count}, () => Math.floor(Math.random() * 10));
    }

    window.updateTimeChart = function(period) {
        timeChart.data.labels = generateTimeLabels(period);
        timeChart.data.datasets[0].data = generateRandomData(
            period === 'day' ? 24 : period === 'week' ? 7 : 30
        );
        timeChart.update();
    };

    async function refreshData() {
        try {
            const response = await fetch(window.location.href);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Update activity table
            const newTable = doc.querySelector('.table-responsive');
            const currentTable = document.querySelector('.table-responsive');
            if (newTable && currentTable) {
                currentTable.innerHTML = newTable.innerHTML;
            }

            // Update summary cards
            const newCards = doc.querySelectorAll('.card-body');
            const currentCards = document.querySelectorAll('.card-body');
            newCards.forEach((newCard, index) => {
                if (currentCards[index] && !newCard.querySelector('canvas')) {
                    currentCards[index].innerHTML = newCard.innerHTML;
                }
            });
        } catch (error) {
            console.error('Error refreshing data:', error);
            autoRefreshToggle.checked = false;
            clearInterval(refreshInterval);
        }
    }
});
</script>
{% endblock %}