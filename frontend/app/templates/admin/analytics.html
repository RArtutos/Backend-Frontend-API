{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Analytics Dashboard</h2>
    
    <div class="row">
        <!-- Summary Cards -->
        {% set total_users = analytics.accounts|map(attribute='total_users')|sum %}
        {% set total_active = analytics.accounts|map(attribute='active_users')|sum %}
        {% set total_sessions = analytics.accounts|map(attribute='active_sessions')|sum %}
        
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Total Users</h5>
                    <h2 class="card-text">{{ total_users }}</h2>
                    <div class="mt-2">
                        <small class="text-{{ 'success' if total_active > 0 else 'muted' }}">
                            {{ ((total_active / total_users * 100) if total_users > 0 else 0)|round|int }}% active
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Active Users</h5>
                    <h2 class="card-text">{{ total_active }}</h2>
                    <div class="mt-2">
                        <small class="text-muted">across all accounts</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Active Sessions</h5>
                    <h2 class="card-text">{{ total_sessions }}</h2>
                    <div class="mt-2">
                        <small class="text-muted">current sessions</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Accounts</h5>
                    <h2 class="card-text">{{ analytics.accounts|length }}</h2>
                    <div class="mt-2">
                        <small class="text-muted">total accounts</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Usage Over Time -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">System Usage Over Time</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateUsageChart('day')">Day</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateUsageChart('week')">Week</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateUsageChart('month')">Month</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="usageChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Account Distribution -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Account Usage Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="accountDistributionChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Account Status -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Account Status</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefreshAccounts">
                        <label class="form-check-label" for="autoRefreshAccounts">Auto refresh</label>
                    </div> </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Users</th>
                                    <th>Sessions</th>
                                    <th>Capacity</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for account in analytics.accounts %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if account.image_url %}
                                            <img src="{{ account.image_url }}" alt="{{ account.name }}" class="me-2" style="width: 24px; height: 24px; object-fit: cover; border-radius: 4px;">
                                            {% else %}
                                            <i class="bi bi-person-badge me-2"></i>
                                            {% endif %}
                                            {{ account.name }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                                {% set user_percentage = (account.active_users / account.total_users * 100 if account.total_users > 0 else 0)|round|int %}
                                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ user_percentage }}%"></div>
                                            </div>
                                            <span>{{ account.active_users }}/{{ account.total_users }}</span>
                                        </div>
                                    </td>
                                    <td>{{ account.active_sessions }}</td>
                                    <td>
                                        {% set capacity = (account.active_sessions / account.max_concurrent_users * 100)|round|int %}
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-{{ 'success' if capacity < 80 else 'warning' if capacity < 100 else 'danger' }}" 
                                                 role="progressbar" 
                                                 style="width: {{ capacity }}%">
                                            </div>
                                        </div>
                                        <small class="text-muted">{{ capacity }}%</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if account.active_sessions > 0 else 'secondary' }}">
                                            {{ 'Active' if account.active_sessions > 0 else 'Inactive' }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Activity</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefreshActivity">
                        <label class="form-check-label" for="autoRefreshActivity">Auto refresh</label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for activity in analytics.recent_activity %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-{{ 'success' if activity.action == 'login' else 'danger' if activity.action == 'logout' else 'info' }}"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-0">{{ activity.user_id }}</h6>
                                    <small class="text-muted">{{ moment(activity.timestamp).fromNow() }}</small>
                                </div>
                                <p class="mb-0">
                                    <span class="badge bg-{{ 'success' if activity.action == 'login' else 'danger' if activity.action == 'logout' else 'info' }}">
                                        {{ activity.action }}
                                    </span>
                                    on account <strong>{{ activity.account_id }}</strong>
                                    {% if activity.domain %}
                                    from <span class="badge bg-secondary">{{ activity.domain }}</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding: 1rem 0;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 1rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    padding-left: 3rem;
    padding-bottom: 1.5rem;
}

.timeline-marker {
    position: absolute;
    left: calc(1rem - 4px);
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px currentColor;
}

.timeline-content {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 0.25rem;
}
</style>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Account Distribution Chart
    const accountCtx = document.getElementById('accountDistributionChart').getContext('2d');
    new Chart(accountCtx, {
        type: 'doughnut',
        data: {
            labels: {{ analytics.accounts|map(attribute='name')|list|tojson }},
            datasets: [{
                data: {{ analytics.accounts|map(attribute='active_sessions')|list|tojson }},
                backgroundColor: [
                    '#4B91F1', '#FF6B6B', '#4BC0C0', '#FFCD56', '#C9CBCF',
                    '#B39DDB', '#81C784', '#FFB74D', '#E57373', '#9575CD'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12
                    }
                }
            }
        }
    });

    // Usage Chart
    const usageCtx = document.getElementById('usageChart').getContext('2d');
    const usageChart = new Chart(usageCtx, {
        type: 'line',
        data: {
            labels: generateTimeLabels('day'),
            datasets: [{
                label: 'Active Sessions',
                data: generateRandomData(24),
                borderColor: '#4B91F1',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(75, 145, 241, 0.1)'
            }, {
                label: 'Active Users',
                data: generateRandomData(24),
                borderColor: '#4BC0C0',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(75, 192, 192, 0.1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Auto refresh functionality
    const autoRefreshToggles = {
        accounts: document.getElementById('autoRefreshAccounts'),
        activity: document.getElementById('autoRefreshActivity')
    };
    let refreshIntervals = {};

    Object.entries(autoRefreshToggles).forEach(([key, toggle]) => {
        toggle.addEventListener('change', function() {
            if (this.checked) {
                refreshIntervals[key] = setInterval(() => refreshData(key), 30000); // 30 seconds
            } else {
                clearInterval(refreshIntervals[key]);
            }
        });
    });

    // Helper functions
    function generateTimeLabels(period) {
        const labels = [];
        const now = moment();
        let count;
        let format;

        switch(period) {
            case 'day':
                count = 24;
                format = 'HH:mm';
                break;
            case 'week':
                count = 7;
                format = 'ddd';
                break;
            case 'month':
                count = 30;
                format = 'MMM D';
                break;
        }

        for (let i = count - 1; i >= 0; i--) {
            labels.push(moment(now).subtract(i, period === 'day' ? 'hours' : 'days').format(format));
        }
        return labels;
    }

    function generateRandomData(count) {
        return Array.from({length: count}, () => Math.floor(Math.random() * 10));
    }

    window.updateUsageChart = function(period) {
        usageChart.data.labels = generateTimeLabels(period);
        usageChart.data.datasets.forEach(dataset => {
            dataset.data = generateRandomData(
                period === 'day' ? 24 : period === 'week' ? 7 : 30
            );
        });
        usageChart.update();
    };

    async function refreshData(section) {
        try {
            const response = await fetch(window.location.href);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            if (section === 'accounts') {
                const newTable = doc.querySelector('.table-responsive');
                const currentTable = document.querySelector('.table-responsive');
                if (newTable && currentTable) {
                    currentTable.innerHTML = newTable.innerHTML;
                }
            } else if (section === 'activity') {
                const newTimeline = doc.querySelector('.timeline');
                const currentTimeline = document.querySelector('.timeline');
                if (newTimeline && currentTimeline) {
                    currentTimeline.innerHTML = newTimeline.innerHTML;
                }
            }

            // Update summary cards
            const newCards = doc.querySelectorAll('.card-body');
            const currentCards = document.querySelectorAll('.card-body');
            newCards.forEach((newCard, index) => {
                if (currentCards[index] && !newCard.querySelector('canvas')) {
                    currentCards[index].innerHTML = newCard.innerHTML;
                }
            });
        } catch (error) {
            console.error('Error refreshing data:', error);
            if (autoRefreshToggles[section]) {
                autoRefreshToggles[section].checked = false;
                clearInterval(refreshIntervals[section]);
            }
        }
    }
});
</script>
{% endblock %}